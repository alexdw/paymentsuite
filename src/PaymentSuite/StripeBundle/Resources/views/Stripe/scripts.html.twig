<script type="text/javascript" src="https://js.stripe.com/v2/"></script>

<script type="text/javascript">
    var STRIPE_PUBLIC_KEY = '{{ public_key }}';
    // This identifies your website in the createToken call below
    Stripe.setPublishableKey(STRIPE_PUBLIC_KEY);

    var errorMessages = {
        incorrect_number: "{{ 'stripe.error.incorrect_number'|trans({}, 'stripe') }}",
        invalid_number: "{{ 'stripe.error.invalid_number'|trans({}, 'stripe') }}",
        invalid_expiry_month: "{{ 'stripe.error.invalid_expiry_month'|trans({}, 'stripe') }}",
        invalid_expiry_year: "{{ 'stripe.error.invalid_expiry_year'|trans({}, 'stripe') }}",
        invalid_cvc: "{{ 'stripe.error.invalid_cvc'|trans({}, 'stripe') }}",
        expired_card: "{{ 'stripe.error.expired_card'|trans({}, 'stripe') }}",
        incorrect_cvc: "{{ 'stripe.error.incorrect_cvc'|trans({}, 'stripe') }}",
        incorrect_zip: "{{ 'stripe.error.incorrect_zip'|trans({}, 'stripe') }}",
        card_declined: "{{ 'stripe.error.card_declined'|trans({}, 'stripe') }}",
        missing: "{{ 'stripe.error.missing'|trans({}, 'stripe') }}",
        processing_error: "{{ 'stripe.error.processing_error'|trans({}, 'stripe') }}",
        rate_limit:  "{{ 'stripe.error.rate_limit'|trans({}, 'stripe') }}",
    };

    /**
     * Validation for stripe payment
     */
    var stripeResponseHandler = function(status, response) {
        var $form = $('#payment-form');

        if (response.error) {
            var errorMsg = response.error.message;
            if (response.error.type == 'card_error' && response.error.code in errorMessages) {
                errorMsg = errorMessages[response.error.code];
            }

            // Show the errors on the form
            $form.find('.payment-errors').text(errorMsg);
            $form.find('button').prop('disabled', false);
        } else {
            // token contains id, last4, and card type
            var token = response.id;
            // Insert the token into the form so it gets submitted to the server
            $form.append($('<input type="hidden" name="stripeToken" />').val(token));
            $('#stripe_view_api_token').val($('#stripe_view__token').val());
            // and submit
            $form.get(0).submit();
        }
    };

    $("#payment-submit").on("click", function(event){
        var $form = $(this).closest('form');
        $form.find('button').prop('disabled', true);

        Stripe.createToken($form, stripeResponseHandler);

        return false;
    });
</script>
